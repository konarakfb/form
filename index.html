<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Dry Store Stock Record</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body {
        font-family: Arial;
        background: #f4f4f4;
        margin: 0;
        padding: 12px;
    }

    .wrapper {
        max-width: 1200px;
        margin: auto;
    }

    .sheet {
        background: #fff;
        border: 1px solid #000;
        padding: 18px;
    }

    /* HEADER */
    .header {
        display: flex;
        align-items: center;
        border-bottom: 1px solid #000;
        padding-bottom: 10px;
        margin-bottom: 12px;
    }

    .header img {
        width: 130px;
        margin-right: 20px;
    }

    .header-title {
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        width: 100%;
    }

    .header-sub {
        text-align: center;
        margin-top: 3px;
        font-size: 12px;
        line-height: 1.2;
    }

    /* TOP FIELDS */
    .top-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
    }

    .top-table td {
        border: 1px solid #000;
        padding: 6px;
        font-size: 14px;
    }

    .top-table input {
        width: 100%;
        border: none;
        outline: none;
        font-size: 14px;
        padding: 2px 4px;
        box-sizing: border-box;
    }

    /* BODY TABLE */
    .table-wrap {
        width: 100%;
        overflow-x: auto;
    }

    .main-table {
        width: 1400px;
        border-collapse: collapse;
        table-layout: fixed;
    }

    .main-table th,
    .main-table td {
        border: 1px solid #000;
        padding: 6px 5px;
        text-align: center;
        font-size: 13px;
    }

    .main-table input {
        width: 100%;
        border: none;
        outline: none;
        padding: 4px;
        font-size: 13px;
        box-sizing: border-box;
        text-align: center;
    }

    .locked input {
        background: transparent;
        color: #111;
    }

    /* FOOTER */
    .bottom-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
    }

    .bottom-table td {
        border: 1px solid #000;
        padding: 6px;
        font-size: 14px;
    }

    /* BUTTONS */
    .controls {
        margin-top: 14px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    button {
        background: #007bff;
        color: #fff;
        font-size: 14px;
        padding: 10px 14px;
        border: none;
        border-radius: 6px;
    }

    .save { background: #28a745; }
    .pdf { background: #6f42c1; }
    .reset { background: #dc3545; }

    /* PDF PAGES */
    #pdfPages {
        position: fixed;
        top: -99999px;
        left: -99999px;
        visibility: hidden;
    }

    .page {
        width: 297mm;
        height: 210mm;
        padding: 12mm;
        box-sizing: border-box;
        background: #fff;
    }
</style>
</head>

<body>

<div class="wrapper">

    <div class="sheet" id="sheet">

        <!-- HEADER -->
        <div class="header">
            <img src="logo.png" alt="logo">
            <div style="width:100%;">
                <div class="header-title">Dry Store Stock Record</div>
                <div class="header-sub">
                    Release ID: CQAG-DSSR / 1.1.0 / 01-Jan-2023 | C3: Private | Controlled Copy <br>
                    Project ID: &lt;Project ID&gt; / &lt;SCL-ID&gt; / Ver - &lt;No&gt;
                </div>
            </div>
        </div>

        <!-- TOP INPUT ROW -->
        <table class="top-table">
            <tr>
                <td style="width:33%">Date: <input type="date" id="date"></td>
                <td style="width:33%">Vendor Name: <input id="vendor"></td>
                <td style="width:33%">Vendor Supervisor Name: <input id="supervisor"></td>
            </tr>
        </table>

        <!-- MAIN TABLE -->
        <div class="table-wrap">
            <table class="main-table" id="mainTable">
                <thead>
                    <tr>
                        <th style="width:50px">S.No</th>
                        <th style="width:220px">Items</th>
                        <th style="width:160px">Batch No</th>
                        <th style="width:150px">Receiving Date</th>
                        <th style="width:150px">Manufacturing Date</th>
                        <th style="width:140px">Expiry Date</th>
                        <th style="width:100px">Shelf Life</th>
                        <th style="width:130px">Stock Quantity</th>
                        <th style="width:200px">Remarks</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>

        <!-- FOOTER -->
        <table class="bottom-table">
            <tr>
                <td style="width:50%">Vendor PoC :</td>
                <td style="width:50%">Verified by F&B team :</td>
            </tr>
        </table>
    </div>

    <div class="controls">
        <button onclick="addRow()">Add Row</button>
        <button class="save" onclick="saveRows()">Save (Lock)</button>
        <button class="pdf" onclick="downloadPDF()">Download PDF</button>
        <button class="reset" onclick="resetAll()">Reset</button>
    </div>

</div>

<div id="pdfPages"></div>

<script>
let data = [];
const STORAGE_KEY = "dry_store_final_2025";
const ROWS_PER_PAGE = 13;

function addRow(values=null) {
    const tbody = document.getElementById("tbody");
    const row = document.createElement("tr");

    const index = data.length + 1;

    const rowData = values || {
        item:"",
        batch:"",
        rec:"",
        mfg:"",
        exp:"",
        shelf:"",
        qty:"",
        remarks:"",
        locked:false
    };

    data.push(rowData);

    const inputs = `
        <td>${index}</td>
        <td><input value="${rowData.item}"></td>
        <td><input value="${rowData.batch}"></td>
        <td><input type="date" value="${rowData.rec}"></td>
        <td><input type="date" value="${rowData.mfg}"></td>
        <td><input type="date" value="${rowData.exp}"></td>
        <td><input value="${rowData.shelf}"></td>
        <td><input value="${rowData.qty}"></td>
        <td><input value="${rowData.remarks}"></td>
    `;

    row.innerHTML = inputs;
    if (rowData.locked) row.classList.add("locked");

    tbody.appendChild(row);
}

function saveRows() {
    const tbody = document.querySelectorAll("#tbody tr");

    tbody.forEach((tr,i)=>{
        let tds = tr.querySelectorAll("input");
        data[i] = {
            item: tds[0].value,
            batch: tds[1].value,
            rec: tds[2].value,
            mfg: tds[3].value,
            exp: tds[4].value,
            shelf: tds[5].value,
            qty: tds[6].value,
            remarks: tds[7].value,
            locked: true
        };
        tr.classList.add("locked");
        tds.forEach(i=>i.disabled=true);
    });

    localStorage.setItem(STORAGE_KEY, JSON.stringify({
        date:date.value,
        vendor:vendor.value,
        supervisor:supervisor.value,
        rows:data
    }));

    alert("Saved & Locked!");
}

function resetAll() {
    if(!confirm("Clear everything?")) return;
    data=[];
    document.getElementById("tbody").innerHTML="";
    localStorage.removeItem(STORAGE_KEY);
}

window.onload = ()=>{
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved){
        const obj = JSON.parse(saved);
        date.value=obj.date;
        vendor.value=obj.vendor;
        supervisor.value=obj.supervisor;
        obj.rows.forEach(r=>addRow(r));
    } else {
        addRow();
        addRow();
    }
}

/* PDF EXPORT */
async function downloadPDF(){
    const { jsPDF } = window.jspdf;

    const header = {
        date:date.value,
        vendor:vendor.value,
        supervisor:supervisor.value
    };

    // sync unsaved rows
    const trs = document.querySelectorAll("#tbody tr");
    trs.forEach((tr,i)=>{
        const ins = tr.querySelectorAll("input");
        data[i].item = ins[0].value;
        data[i].batch = ins[1].value;
        data[i].rec = ins[2].value;
        data[i].mfg = ins[3].value;
        data[i].exp = ins[4].value;
        data[i].shelf = ins[5].value;
        data[i].qty = ins[6].value;
        data[i].remarks = ins[7].value;
    });

    let pages = [];
    for(let i=0; i<data.length; i+=ROWS_PER_PAGE){
        pages.push(data.slice(i, i+ROWS_PER_PAGE));
    }

    const pdf = new jsPDF({
        orientation:'landscape',
        unit:'mm',
        format:'a4',
        compress:true
    });

    const container = document.getElementById("pdfPages");
    container.innerHTML="";

    for(let p=0; p<pages.length; p++){
        const page = document.createElement("div");
        page.className="page";
        container.appendChild(page);

        // BUILD EXACT PAGE
        page.innerHTML = `
            <div style="display:flex;align-items:center;border-bottom:1px solid #000;padding-bottom:8px;margin-bottom:8px;">
                <img src="logo.png" style="width:110px;margin-right:15px;">
                <div style="width:100%;text-align:center;">
                    <div style="font-size:16px;font-weight:bold;">Dry Store Stock Record</div>
                    <div style="font-size:11px;margin-top:3px;">
                        Release ID: CQAG-DSSR / 1.1.0 / 01-Jan-2023 | C3: Private | Controlled Copy<br>
                        Project ID: &lt;Project ID&gt; / &lt;SCL-ID&gt; / Ver - &lt;No&gt;
                    </div>
                </div>
            </div>

            <table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:6px;">
                <tr>
                    <td style="border:1px solid #000;padding:5px;">Date: ${header.date}</td>
                    <td style="border:1px solid #000;padding:5px;">Vendor Name: ${header.vendor}</td>
                    <td style="border:1px solid #000;padding:5px;">Vendor Supervisor Name: ${header.supervisor}</td>
                </tr>
            </table>

            <table style="width:100%;border-collapse:collapse;font-size:12px;">
                <thead>
                    <tr>
                        <th style="border:1px solid #000;padding:5px;width:40px;">S.No</th>
                        <th style="border:1px solid #000;padding:5px;">Items</th>
                        <th style="border:1px solid #000;padding:5px;">Batch No</th>
                        <th style="border:1px solid #000;padding:5px;">Receiving Date</th>
                        <th style="border:1px solid #000;padding:5px;">Manufacturing Date</th>
                        <th style="border:1px solid #000;padding:5px;">Expiry Date</th>
                        <th style="border:1px solid #000;padding:5px;">Shelf Life</th>
                        <th style="border:1px solid #000;padding:5px;">Stock Qty</th>
                        <th style="border:1px solid #000;padding:5px;">Remarks</th>
                    </tr>
                </thead>
                <tbody>
                    ${pages[p].map((r,i)=>`
                        <tr>
                            <td style="border:1px solid #000;padding:5px;">${(p*ROWS_PER_PAGE)+i+1}</td>
                            <td style="border:1px solid #000;padding:5px;">${r.item}</td>
                            <td style="border:1px solid #000;padding:5px;">${r.batch}</td>
                            <td style="border:1px solid #000;padding:5px;">${r.rec}</td>
                            <td style="border:1px solid #000;padding:5px;">${r.mfg}</td>
                            <td style="border:1px solid #000;padding:5px;">${r.exp}</td>
                            <td style="border:1px solid #000;padding:5px;">${r.shelf}</td>
                            <td style="border:1px solid #000;padding:5px;">${r.qty}</td>
                            <td style="border:1px solid #000;padding:5px;">${r.remarks}</td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>

            <table style="width:100%;border-collapse:collapse;font-size:12px;margin-top:6px;">
                <tr>
                    <td style="border:1px solid #000;padding:5px;">Vendor PoC :</td>
                    <td style="border:1px solid #000;padding:5px;">Verified by F&B team :</td>
                </tr>
            </table>
        `;

        await new Promise(res=>{
            const img=page.querySelector("img");
            if(!img||img.complete)res();
            else img.onload=res;
        });

        const canvas = await html2canvas(page, {scale:1.4});
        const img = canvas.toDataURL('image/jpeg',0.62);

        if(p>0) pdf.addPage();
        pdf.addImage(img, "JPEG", 0, 0, 297, 210);

        container.innerHTML="";
    }

    pdf.save("Dry_Store_Record.pdf");
}
</script>

</body>
</html>
